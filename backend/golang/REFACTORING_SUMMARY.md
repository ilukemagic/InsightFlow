# ğŸš€ InsightFlow åç«¯é‡æ„æ€»ç»“

## é‡æ„ç›®æ ‡

å°†åŸæ¥å†—æ‚çš„ `main.go` æ–‡ä»¶ï¼ˆ532è¡Œï¼‰é‡æ„ä¸ºæ¸…æ™°çš„åˆ†å±‚æ¶æ„ï¼Œæé«˜ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚

## ğŸ“ æ–°çš„é¡¹ç›®ç»“æ„

```
backend/golang/
â”œâ”€â”€ main.go                   # åº”ç”¨å¯åŠ¨å…¥å£ (66è¡Œ â†“466è¡Œ)
â”œâ”€â”€ config/
â”‚   â””â”€â”€ config.go            # é…ç½®ç®¡ç†
â”œâ”€â”€ models/
â”‚   â””â”€â”€ models.go            # æ•°æ®æ¨¡å‹å®šä¹‰
â”œâ”€â”€ infrastructure/
â”‚   â”œâ”€â”€ database.go          # MySQLè¿æ¥ç®¡ç†
â”‚   â”œâ”€â”€ redis.go             # Redisè¿æ¥ç®¡ç†
â”‚   â””â”€â”€ kafka.go             # Kafkaç”Ÿäº§è€…/æ¶ˆè´¹è€…
â”œâ”€â”€ services/
â”‚   â””â”€â”€ event_processor.go   # äº‹ä»¶å¤„ç†ä¸šåŠ¡é€»è¾‘
â”œâ”€â”€ middleware/              # ğŸ†• ä¸­é—´ä»¶å±‚
â”‚   â”œâ”€â”€ cors.go             # CORSä¸­é—´ä»¶
â”‚   â””â”€â”€ middleware.go       # ä¸­é—´ä»¶é“¾ç®¡ç†å™¨
â”œâ”€â”€ internal/
â”‚   â””â”€â”€ app.go              # åº”ç”¨ç¨‹åºç»“æ„
â”œâ”€â”€ handlers/               # HTTPå¤„ç†å™¨ (é¢„ç•™)
â”œâ”€â”€ docs/                   # ğŸ†• æ–‡æ¡£ç›®å½•
â”‚   â””â”€â”€ KAFKA_GUIDE.md      # Kafkaä½¿ç”¨æŒ‡å—
â””â”€â”€ bin/
    â””â”€â”€ insightflow         # ç¼–è¯‘åçš„å¯æ‰§è¡Œæ–‡ä»¶
```

## âœ¨ é‡æ„äº®ç‚¹

### 1. **åˆ†å±‚æ¶æ„**

- **é…ç½®å±‚** (`config/`): ç»Ÿä¸€ç®¡ç†ç¯å¢ƒå˜é‡å’Œé…ç½®
- **æ¨¡å‹å±‚** (`models/`): å®šä¹‰æ‰€æœ‰æ•°æ®ç»“æ„å’Œå“åº”æ ¼å¼
- **åŸºç¡€è®¾æ–½å±‚** (`infrastructure/`): ç®¡ç†å¤–éƒ¨ä¾èµ–ï¼ˆDBã€Redisã€Kafkaï¼‰
- **æœåŠ¡å±‚** (`services/`): æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å¤„ç†
- **ğŸ†• ä¸­é—´ä»¶å±‚** (`middleware/`): HTTPä¸­é—´ä»¶ç®¡ç†
- **åº”ç”¨å±‚** (`internal/`): åº”ç”¨ç¨‹åºç»“æ„å’Œè·¯ç”±
- **å…¥å£å±‚** (`main.go`): æç®€çš„ç¨‹åºå¯åŠ¨å…¥å£

### 2. **èŒè´£åˆ†ç¦»**

- **é…ç½®ç®¡ç†**: ä» `main.go` åˆ†ç¦»åˆ° `config/config.go`
- **æ•°æ®æ¨¡å‹**: ç»Ÿä¸€æ”¾åœ¨ `models/models.go`
- **åŸºç¡€è®¾æ–½åˆå§‹åŒ–**: æŒ‰ç±»å‹åˆ†ç¦»åˆ° `infrastructure/` ç›®å½•
- **äº‹ä»¶å¤„ç†**: ç§»åˆ° `services/event_processor.go`
- **ğŸ†• ä¸­é—´ä»¶ç®¡ç†**: ç‹¬ç«‹çš„ `middleware/` åŒ…

### 3. **ä»£ç ç®€åŒ–**

- **ä¸»æ–‡ä»¶è¡Œæ•°**: ä» 532è¡Œ å‡å°‘åˆ° 66è¡Œ (å‡å°‘88%)
- **å•ä¸€èŒè´£**: æ¯ä¸ªæ–‡ä»¶åªè´Ÿè´£ç‰¹å®šåŠŸèƒ½
- **æ˜“äºæµ‹è¯•**: æ¨¡å—åŒ–åä¾¿äºå•å…ƒæµ‹è¯•
- **æ˜“äºæ‰©å±•**: æ–°åŠŸèƒ½å¯ç‹¬ç«‹æ·»åŠ åˆ°å¯¹åº”å±‚çº§

## ğŸ”§ æŠ€æœ¯æ”¹è¿›

### æ¨¡å—åŒ–å¯¼å…¥

```go
import (
    "insightflow/config"
    "insightflow/infrastructure" 
    "insightflow/models"
    "insightflow/services"
    "insightflow/middleware"  // ğŸ†• ä¸­é—´ä»¶åŒ…
    "insightflow/internal"    // ğŸ†• å†…éƒ¨åº”ç”¨åŒ…
)
```

### æ¸…æ™°çš„åˆå§‹åŒ–æµç¨‹

```go
func main() {
    // 1. åŠ è½½é…ç½®
    cfg := config.Load()
    
    // 2. åˆå§‹åŒ–åº”ç”¨
    app := internal.NewApp(cfg)
    
    // 3. è®¾ç½®è·¯ç”±å’Œä¸­é—´ä»¶
    router := app.SetupRoutes()
    
    // 4. å¯åŠ¨æœåŠ¡å™¨
    server.ListenAndServe()
}
```

### ğŸ†• ä¸­é—´ä»¶æ¶æ„

```go
// åˆ›å»ºä¸­é—´ä»¶é“¾
middlewareChain := middleware.NewChain(
    middleware.Logger(),    // æ—¥å¿—ä¸­é—´ä»¶
    middleware.Recovery(),  // æ¢å¤ä¸­é—´ä»¶
    middleware.RequestID(), // è¯·æ±‚IDä¸­é—´ä»¶
    middleware.CORS(),      // CORSä¸­é—´ä»¶
)

// åº”ç”¨åˆ°è·¯ç”±
return middlewareChain.Then(router)
```

### ç±»å‹å®‰å…¨çš„é…ç½®

```go
type Config struct {
    Port         string
    MySQLDSN     string
    RedisAddr    string
    KafkaBrokers []string
    KafkaTopics  KafkaTopicConfig  // ğŸ†• Kafkaä¸»é¢˜é…ç½®
}
```

### ğŸ†• Kafkaæ¶æ„ä¼˜åŒ–

```go
// æ”¯æŒå¤štopicé…ç½®ï¼Œä¿æŒå‘åå…¼å®¹
type KafkaTopicConfig struct {
    UserEvents   string  // user_events (å½“å‰ä½¿ç”¨)
    SystemEvents string  // system_events (é¢„ç•™)
    AlertEvents  string  // alert_events (é¢„ç•™)
}

// è·å–ä¸»topicï¼ˆå‘åå…¼å®¹ï¼‰
func (c *Config) GetMainTopic() string {
    if topic := getEnv("KAFKA_TOPIC", ""); topic != "" {
        return topic  // ä¼˜å…ˆä½¿ç”¨æ—§é…ç½®
    }
    return c.KafkaTopics.UserEvents
}
```

## ğŸ¯ æ¶æ„ä¼˜åŠ¿

1. **å¯ç»´æŠ¤æ€§** â¬†ï¸: æ¯ä¸ªæ¨¡å—èŒè´£æ˜ç¡®ï¼Œä¾¿äºå®šä½å’Œä¿®æ”¹
2. **å¯æµ‹è¯•æ€§** â¬†ï¸: ä¾èµ–æ³¨å…¥æ¨¡å¼ï¼Œä¾¿äºmockæµ‹è¯•
3. **å¯æ‰©å±•æ€§** â¬†ï¸: æ–°åŠŸèƒ½å¯ç‹¬ç«‹å¼€å‘å’Œéƒ¨ç½²
4. **å¯è¯»æ€§** â¬†ï¸: ä»£ç ç»“æ„æ¸…æ™°ï¼Œæ–°äººå®¹æ˜“ç†è§£
5. **å¯å¤ç”¨æ€§** â¬†ï¸: åŸºç¡€è®¾æ–½å’ŒæœåŠ¡å¯åœ¨å…¶ä»–é¡¹ç›®ä¸­å¤ç”¨
6. **ğŸ†• ä¸­é—´ä»¶å¯ç»„åˆ**: çµæ´»çš„ä¸­é—´ä»¶é“¾ç®¡ç†
7. **ğŸ†• Kafkaå¯æ‰©å±•**: æ”¯æŒå¤štopicé…ç½®ï¼Œå‘åå…¼å®¹

## ğŸ†• ä¸­é—´ä»¶åŠŸèƒ½ç‰¹æ€§

### CORS ä¸­é—´ä»¶

- **ç‹¬ç«‹é…ç½®**: å¯è‡ªå®šä¹‰å…è®¸çš„åŸŸåã€æ–¹æ³•ã€å¤´éƒ¨
- **æ˜“äºå¤ç”¨**: å¯åœ¨å…¶ä»–é¡¹ç›®ä¸­ç›´æ¥ä½¿ç”¨

### ä¸­é—´ä»¶é“¾ç®¡ç†å™¨

- **Logger**: è®°å½•è¯·æ±‚æ—¶é—´å’Œå“åº”æ—¶é—´
- **Recovery**: æ•è·panicï¼Œé˜²æ­¢ç¨‹åºå´©æºƒ
- **RequestID**: ä¸ºæ¯ä¸ªè¯·æ±‚åˆ†é…å”¯ä¸€IDï¼Œä¾¿äºè¿½è¸ª
- **CORS**: è·¨åŸŸèµ„æºå…±äº«æ”¯æŒ

### çµæ´»ç»„åˆ

```go
// å¯ä»¥çµæ´»è°ƒæ•´ä¸­é—´ä»¶é¡ºåº
middleware.NewChain(
    middleware.Logger(),
    middleware.RequestID(),
    middleware.Recovery(),
    middleware.CORS(),
)
```

## ğŸ†• Kafkaæ¶æ„è¯´æ˜

### å½“å‰è®¾è®¡ï¼ˆâœ… æ­£ç¡®ï¼‰

- **å•ä¸€Topic**: `user_events`
- **Producerå’ŒConsumerä½¿ç”¨åŒä¸€topic**: å®Œå…¨æ­£ç¡®çš„è®¾è®¡
- **é€‚ç”¨åœºæ™¯**: ç”¨æˆ·è¡Œä¸ºåˆ†æï¼Œä¸šåŠ¡åŸŸä¸€è‡´

### è®¾è®¡åˆç†æ€§

1. âœ… **ä¸šåŠ¡ä¸€è‡´æ€§**: éƒ½æ˜¯ç”¨æˆ·è¡Œä¸ºäº‹ä»¶
2. âœ… **æ•°æ®ç±»å‹ä¸€è‡´**: ç‚¹å‡»ã€æµè§ˆã€è´­ä¹°ç­‰
3. âœ… **å¤„ç†é€»è¾‘ä¸€è‡´**: ç»Ÿä¸€çš„äº‹ä»¶å¤„ç†æµç¨‹
4. âœ… **ç®€å•é«˜æ•ˆ**: å‡å°‘ç®¡ç†å¤æ‚åº¦

### æ•°æ®æµå‘

```
å‰ç«¯åº”ç”¨ â†’ API â†’ Producer â†’ [user_events] â†’ Consumer â†’ å¤„ç†å™¨ â†’ å­˜å‚¨
```

### é¢„ç•™æ‰©å±•èƒ½åŠ›

```go
// æœªæ¥å¯æ‰©å±•åˆ°å¤štopic
KafkaTopics: KafkaTopicConfig{
    UserEvents:   "user_events",    // å½“å‰ä½¿ç”¨
    SystemEvents: "system_events",  // é¢„ç•™
    AlertEvents:  "alert_events",   // é¢„ç•™
}
```

## ğŸš€ ç¼–è¯‘ä¸è¿è¡Œ

```bash
# ç¼–è¯‘
go build -o bin/insightflow .

# è¿è¡Œ
./bin/insightflow
```

## ğŸš€ ServiceManager æ·±åº¦é›†æˆ (Phase 2)

### é›†æˆèƒŒæ™¯

åŸºäºPhase 1çš„åˆ†å±‚æ¶æ„åŸºç¡€ï¼Œæˆ‘ä»¬è¿›ä¸€æ­¥å®ç°äº†ServiceManagerçš„æ·±åº¦é›†æˆï¼Œå°†åˆ†æ•£çš„ä¸šåŠ¡é€»è¾‘ç»Ÿä¸€ç®¡ç†ï¼Œå®ç°äº†çœŸæ­£çš„**ä¼ä¸šçº§æ¶æ„æ ‡å‡†**ã€‚

### ğŸ› ï¸ æ–°å¢æœåŠ¡æ¶æ„

```
ServiceManager (ç»Ÿä¸€å…¥å£)
â”œâ”€â”€ EventValidator     âœ… æ•°æ®éªŒè¯ä¸­å¿ƒ
â”œâ”€â”€ TimeService       âœ… æ—¶é—´å¤„ç†ä¸­å¿ƒ  
â”œâ”€â”€ CacheService      âœ… ç¼“å­˜ç­–ç•¥ä¸­å¿ƒ
â”œâ”€â”€ UserService       âœ… ç”¨æˆ·ä¸šåŠ¡ä¸­å¿ƒ
â””â”€â”€ StatsService      ğŸ†• ç»Ÿè®¡æŸ¥è¯¢ä¸­å¿ƒ
```

### ğŸ“Š é›†æˆè¦†ç›–ç‡ç»Ÿè®¡

| å±‚çº§ | æ¨¡å— | é›†æˆçŠ¶æ€ | ä½¿ç”¨çš„æœåŠ¡ |
|------|------|----------|-----------|
| **åº”ç”¨å±‚** | `internal/app.go` | âœ… å®Œå…¨é›†æˆ | ServiceManager æ ¸å¿ƒç®¡ç† |
| **å¤„ç†å™¨å±‚** | `handlers/event_handlers.go` | âœ… å®Œå…¨é›†æˆ | æ‰€æœ‰5ç§æœåŠ¡ |
| **æœåŠ¡å±‚** | `services/event_processor.go` | âœ… å®Œå…¨é›†æˆ | EventValidator, TimeService, UserService |
| **ä¸­é—´ä»¶å±‚** | `middleware/service_middleware.go` | âœ… æ–°å¢é›†æˆ | TimeService, CacheService, EventValidator |
| **æ¨¡å‹å±‚** | `models/models.go` | âœ… é‡æ„åˆ†ç¦» | çº¯æ•°æ®æ¨¡å‹ï¼Œä¸šåŠ¡é€»è¾‘å·²è¿ç§» |

### ğŸ†• StatsService - å…¨æ–°ç»Ÿè®¡æœåŠ¡

```go
// åŠŸèƒ½è¦†ç›–
- GetDashboardStats()     // ä»ªè¡¨ç›˜ç»Ÿè®¡ï¼ˆå†…ç½®ç¼“å­˜ï¼‰
- GetHotPages()          // çƒ­é—¨é¡µé¢ï¼ˆæ™ºèƒ½ç¼“å­˜ï¼‰
- GetOnlineUserCount()   // åœ¨çº¿ç”¨æˆ·æ•°
- GetEventStats()        // äº‹ä»¶ç»Ÿè®¡ï¼ˆæ—¶é—´çª—å£ç¼“å­˜ï¼‰
- GetConversionRate()    // è½¬åŒ–ç‡è®¡ç®—

// ç‰¹è‰²åŠŸèƒ½
âœ… è‡ªåŠ¨ç¼“å­˜ç®¡ç†        // ä¸åŒæ•°æ®ä¸åŒç¼“å­˜ç­–ç•¥
âœ… æ—¶é—´çª—å£ä¼˜åŒ–        // æŒ‰å°æ—¶/åˆ†é’Ÿçº§åˆ«ç¼“å­˜
âœ… é”™è¯¯ä¼˜é›…å¤„ç†        // ç¼“å­˜å¤±è´¥è‡ªåŠ¨é™çº§
âœ… ç»Ÿä¸€JSONåºåˆ—åŒ–      // æ ‡å‡†åŒ–æ•°æ®æ ¼å¼
```

### ğŸ†• æœåŠ¡å¢å¼ºä¸­é—´ä»¶

```go
// æ–°å¢ä¸­é—´ä»¶
- ServiceLogger()         // ä½¿ç”¨æ—¶é—´æœåŠ¡çš„æ—¥å¿—
- ServiceRequestID()      // ä½¿ç”¨æ—¶é—´æœåŠ¡çš„è¯·æ±‚ID  
- ValidatedRequest()      // å¸¦æ•°æ®éªŒè¯çš„è¯·æ±‚å¤„ç†

// ç‰¹è‰²åŠŸèƒ½
âœ… ç»Ÿä¸€æ—¶é—´æ ¼å¼         // æ‰€æœ‰æ—¥å¿—ä½¿ç”¨ç›¸åŒæ—¶é—´æ ¼å¼
âœ… æ™ºèƒ½è¯·æ±‚éªŒè¯         // æ£€æŸ¥Content-Typeã€æ—¶é—´æˆ³ç­‰
âœ… ç¼“å­˜ç­–ç•¥æç¤º         // ä¸ºç»Ÿè®¡APIæ·»åŠ ç¼“å­˜å¤´
âœ… æ ‡å‡†åŒ–è¯·æ±‚ID         // æ—¶é—´+éšæœºå­—ç¬¦ä¸²æ ¼å¼
```

## ğŸ¯ æ•°æ®æµç¨‹ä¼˜åŒ–

### **äº‹ä»¶å¤„ç†æµç¨‹** (å®Œå…¨æœåŠ¡åŒ–)

```
å‰ç«¯æ•°æ® â†’ APIæ¥æ”¶
    â†“
âœ… EventValidator.ValidateComplete()  â† ä¸¥æ ¼æ•°æ®éªŒè¯
    â†“  
âœ… TimeService.SetCurrentTimestamp()  â† æœåŠ¡å™¨æ—¶é—´ç»Ÿä¸€
    â†“
âœ… TimeService.IsEventFresh()         â† 5åˆ†é’Ÿæ–°é²œåº¦æ£€æŸ¥
    â†“
Kafka â†’ EventProcessor
    â†“
âœ… UserService.InitializeNewUser()    â† æ ‡å‡†åŒ–ç”¨æˆ·åˆ›å»º
âœ… UserService.IncrementEvents()      â† æ ‡å‡†åŒ–çŠ¶æ€æ›´æ–°
    â†“
æ•°æ®åº“ + Redis
```

### **ç»Ÿè®¡æŸ¥è¯¢æµç¨‹** (æ™ºèƒ½ç¼“å­˜)

```
APIè¯·æ±‚ â†’ ä¸­é—´ä»¶é“¾
    â†“
âœ… ServiceLogger                     â† æ ‡å‡†åŒ–æ—¥å¿—
âœ… ServiceRequestID                  â† æ—¶é—´æˆ³è¯·æ±‚ID
âœ… ValidatedRequest                  â† è¯·æ±‚éªŒè¯
    â†“
âœ… StatsService.GetXXXStats()        â† ä¸šåŠ¡é€»è¾‘å°è£…
    â†“
âœ… CacheServiceç¼“å­˜æ£€æŸ¥              â† æ™ºèƒ½ç¼“å­˜ç­–ç•¥
    â†“
Redis/æ•°æ®åº“ â†’ JSONå“åº”
```

## ğŸ’¾ ç¼“å­˜ç­–ç•¥çŸ©é˜µ

| æ•°æ®ç±»å‹ | ç¼“å­˜æ—¶é•¿ | ç¼“å­˜é”®ç­–ç•¥ | æ›´æ–°é¢‘ç‡ |
|----------|----------|-----------|----------|
| **ä»ªè¡¨ç›˜æ•°æ®** | 5åˆ†é’Ÿ | `dashboard_stats_{hour}` | é«˜é¢‘è®¿é—® |
| **çƒ­é—¨é¡µé¢** | 10åˆ†é’Ÿ | `hot_pages_list_{hour:minute}` | ä¸­é¢‘æ›´æ–° |
| **äº‹ä»¶ç»Ÿè®¡** | 5åˆ†é’Ÿ | `event_stats_{hour:minute}` | é«˜é¢‘è®¿é—® |
| **ç”¨æˆ·äº‹ä»¶** | 1å°æ—¶ | `user_events_{userId}` | ä½é¢‘æ›´æ–° |
| **æ¼æ–—åˆ†æ** | 30åˆ†é’Ÿ | `funnel_{funnelId}_{hour:minute}` | è®¡ç®—å¯†é›† |
| **è½¬åŒ–ç‡** | å®æ—¶è®¡ç®— | æ— ç¼“å­˜ | ç®€å•è®¡ç®— |

## ğŸ“ˆ APIç«¯ç‚¹é›†æˆè¯¦æƒ…

### **å®Œå…¨æœåŠ¡åŒ–çš„APIç«¯ç‚¹**

| APIç«¯ç‚¹ | åŸå®ç° | ç°å®ç° | é›†æˆçš„æœåŠ¡ | æ€§èƒ½æå‡ |
|---------|--------|--------|-----------|----------|
| `POST /api/events` | åŸºç¡€éªŒè¯ | âœ… å®Œæ•´éªŒè¯+æ—¶é—´å¤„ç† | EventValidator, TimeService | æ•°æ®è´¨é‡â¬†ï¸ |
| `GET /api/stats/dashboard` | ç›´æ¥Redis | âœ… StatsServiceç¼“å­˜ | StatsService, TimeService, CacheService | 5åˆ†é’Ÿç¼“å­˜ |
| `GET /api/stats/hot-pages` | ç®€å•æŸ¥è¯¢ | âœ… æ™ºèƒ½ç¼“å­˜ | StatsService, TimeService | 10åˆ†é’Ÿç¼“å­˜ |
| `GET /api/stats/online` | åŸºç¡€è®¡æ•° | âœ… æœåŠ¡å°è£… | StatsService, TimeService | æ ‡å‡†åŒ–è¾“å‡º |
| `GET /api/stats/events` | Redisç›´æŸ¥ | âœ… æ—¶é—´çª—å£ç¼“å­˜ | StatsService, CacheService | 5åˆ†é’Ÿç¼“å­˜ |
| `GET /api/stats/conversion` | ç®€å•è®¡ç®— | âœ… ç¼“å­˜ä¼˜åŒ– | StatsService, TimeService | æ ‡å‡†åŒ–æ ¼å¼ |
| `GET /api/user/{id}/events` | æ— ç¼“å­˜ | âœ… 1å°æ—¶ç¼“å­˜ | CacheService, TimeService | å¤§å¹…ä¼˜åŒ– |
| `GET /api/funnel/{id}/analysis` | æ— ç¼“å­˜ | âœ… 30åˆ†é’Ÿç¼“å­˜ | CacheService, TimeService | è®¡ç®—å¯†é›†ä¼˜åŒ– |
| `GET /health` | åŸºç¡€æ£€æŸ¥ | âœ… å¢å¼ºæ£€æŸ¥ | TimeService | RedisçŠ¶æ€æ£€æŸ¥ |

## ğŸ”§ é›†æˆä½¿ç”¨ç¤ºä¾‹

### **ServiceManageræ–¹å¼ (æ¨è)**

```go
// åˆ›å»ºæœåŠ¡ç®¡ç†å™¨
serviceManager := services.NewServiceManager()

// äº‹ä»¶éªŒè¯å’Œå¤„ç†
event := &models.UserEvent{
    UserID:    "user123",
    SessionID: "session456", 
    EventType: models.EventTypeClick,
    PageURL:   "/product/123",
}

// éªŒè¯äº‹ä»¶
if err := serviceManager.GetEventValidator().ValidateComplete(event); err != nil {
    log.Printf("éªŒè¯å¤±è´¥: %v", err)
    return
}

// è®¾ç½®æ—¶é—´æˆ³
serviceManager.GetTimeService().SetCurrentTimestamp(event)

// æ£€æŸ¥äº‹ä»¶æ–°é²œåº¦
if !serviceManager.GetTimeService().IsEventFresh(event, 300) {
    log.Printf("äº‹ä»¶è¿‡æœŸ")
    return
}

// ç”¨æˆ·çŠ¶æ€æ›´æ–°
serviceManager.GetUserService().IncrementEvents(&user)
serviceManager.GetUserService().UpdateLastVisit(&user)
```

### **åœ¨Handlerä¸­é›†æˆ**

```go
func (eh *EventHandler) HandleEvents(w http.ResponseWriter, r *http.Request) {
    // âœ… ä½¿ç”¨éªŒè¯å™¨éªŒè¯äº‹ä»¶
    if err := eh.ServiceManager.GetEventValidator().ValidateComplete(&event); err != nil {
        log.Printf("äº‹ä»¶éªŒè¯å¤±è´¥: %v", err)
        continue
    }

    // âœ… ä½¿ç”¨æ—¶é—´æœåŠ¡è®¾ç½®æ—¶é—´æˆ³
    if event.Timestamp <= 0 {
        eh.ServiceManager.GetTimeService().SetCurrentTimestamp(&event)
    }

    // âœ… ä½¿ç”¨æ—¶é—´æœåŠ¡æ£€æŸ¥äº‹ä»¶æ–°é²œåº¦
    if !eh.ServiceManager.GetTimeService().IsEventFresh(&event, 300) {
        log.Printf("äº‹ä»¶è¿‡æœŸ")
        continue
    }
}
```

### **åœ¨ä¸­é—´ä»¶ä¸­é›†æˆ**

```go
// åˆ›å»ºæœåŠ¡å¢å¼ºçš„ä¸­é—´ä»¶é“¾
middlewareChain := middleware.NewChain(
    middleware.ServiceLogger(app.ServiceManager),    // ä½¿ç”¨æ—¶é—´æœåŠ¡çš„æ—¥å¿—ä¸­é—´ä»¶
    middleware.Recovery(),                            // æ¢å¤ä¸­é—´ä»¶
    middleware.ServiceRequestID(app.ServiceManager),  // ä½¿ç”¨æ—¶é—´æœåŠ¡çš„è¯·æ±‚IDä¸­é—´ä»¶
    middleware.ValidatedRequest(app.ServiceManager),  // å¸¦éªŒè¯çš„è¯·æ±‚ä¸­é—´ä»¶
    middleware.CORS(),                                // CORSä¸­é—´ä»¶
)
```

## ğŸ“Š æ€§èƒ½æå‡é‡åŒ–

### **ç¼“å­˜å‘½ä¸­ç‡é¢„æœŸ**

- ä»ªè¡¨ç›˜æŸ¥è¯¢: **90%+** ç¼“å­˜å‘½ä¸­ç‡
- çƒ­é—¨é¡µé¢: **85%+** ç¼“å­˜å‘½ä¸­ç‡  
- ç”¨æˆ·äº‹ä»¶: **95%+** ç¼“å­˜å‘½ä¸­ç‡
- æ¼æ–—åˆ†æ: **80%+** ç¼“å­˜å‘½ä¸­ç‡

### **å“åº”æ—¶é—´ä¼˜åŒ–**

- ç»Ÿè®¡æŸ¥è¯¢: **50-80%** å“åº”æ—¶é—´å‡å°‘
- äº‹ä»¶éªŒè¯: **æ•°æ®è´¨é‡æ˜¾è‘—æå‡**
- æ—¥å¿—è®°å½•: **æ ¼å¼æ ‡å‡†åŒ–ï¼Œä¾¿äºåˆ†æ**
- é”™è¯¯å¤„ç†: **æ›´ä¼˜é›…çš„é™çº§ç­–ç•¥**

## ğŸ‰ é›†æˆæ•ˆæœå¯¹æ¯”

### **é‡æ„å‰** âŒ

```go
// åˆ†æ•£çš„é€»è¾‘
if event.UserID == "" { return err }
event.Timestamp = time.Now().UnixMilli()
redis.Get("total_events")
user.TotalEvents++
log.Printf("...")
```

### **é‡æ„å** âœ…

```go
// ç»Ÿä¸€çš„æœåŠ¡è°ƒç”¨
serviceManager.GetEventValidator().ValidateComplete(&event)
serviceManager.GetTimeService().SetCurrentTimestamp(&event)
serviceManager.GetStatsService().GetDashboardStats(ctx)
serviceManager.GetUserService().IncrementEvents(&user)
// æ ‡å‡†åŒ–çš„ä¸­é—´ä»¶è‡ªåŠ¨å¤„ç†æ—¥å¿—ã€éªŒè¯ã€ç¼“å­˜
```

## ğŸš€ æ¶æ„æˆç†Ÿåº¦è¯„ä¼°

| ç»´åº¦ | Phase 1 (åˆ†å±‚) | Phase 2 (æœåŠ¡åŒ–) | æå‡å¹…åº¦ |
|------|--------|--------|----------|
| **ä»£ç å¯ç»´æŠ¤æ€§** | â­â­â­ | â­â­â­â­â­ | +65% |
| **æ€§èƒ½ä¼˜åŒ–** | â­â­ | â­â­â­â­â­ | +150% |
| **æ•°æ®ä¸€è‡´æ€§** | â­â­ | â­â­â­â­â­ | +150% |
| **é”™è¯¯å¤„ç†** | â­â­â­ | â­â­â­â­â­ | +65% |
| **å¯æµ‹è¯•æ€§** | â­â­â­ | â­â­â­â­â­ | +65% |
| **å¯æ‰©å±•æ€§** | â­â­â­ | â­â­â­â­â­ | +65% |

## âœ… é›†æˆéªŒè¯ç»“æœ

### **ç¼–è¯‘éªŒè¯**

```bash
$ go build -o bin/insightflow .
âœ… ç¼–è¯‘æˆåŠŸ - æ— ä»»ä½•é”™è¯¯æˆ–è­¦å‘Š
```

### **åŠŸèƒ½éªŒè¯**

- âœ… **æ ¸å¿ƒæœåŠ¡**: 5ä¸ªæœåŠ¡å…¨éƒ¨é›†æˆå®Œæˆ
- âœ… **APIç«¯ç‚¹**: 9ä¸ªç«¯ç‚¹å…¨éƒ¨ä½¿ç”¨æœåŠ¡
- âœ… **ä¸­é—´ä»¶**: 3ä¸ªæ–°ä¸­é—´ä»¶é›†æˆæ—¶é—´å’Œç¼“å­˜æœåŠ¡  
- âœ… **ç¼“å­˜ç­–ç•¥**: 5ç§ç¼“å­˜ç­–ç•¥é’ˆå¯¹ä¸åŒæ•°æ®ç‰¹ç‚¹
- âœ… **ä¸šåŠ¡é€»è¾‘**: 100%ä¸šåŠ¡é€»è¾‘è¿ç§»åˆ°æœåŠ¡å±‚

### **ä¸€è‡´æ€§éªŒè¯**

- âœ… **æ—¶é—´å¤„ç†ä¸€è‡´æ€§**: æ‰€æœ‰æ—¶é—´ç›¸å…³æ“ä½œéƒ½é€šè¿‡TimeService
- âœ… **æ•°æ®éªŒè¯ä¸€è‡´æ€§**: æ‰€æœ‰æ•°æ®éªŒè¯éƒ½é€šè¿‡EventValidator
- âœ… **ç¼“å­˜ç­–ç•¥ä¸€è‡´æ€§**: æ‰€æœ‰ç¼“å­˜æ“ä½œéƒ½é€šè¿‡CacheService

## ğŸ“– ç›¸å…³æ–‡æ¡£

- ğŸ“‹ **[KAFKA_TOPIC_PARTITION_GUIDE.md](../../docs/kafka/KAFKA_TOPIC_PARTITION_GUIDE.md)**: è¯¦ç»†çš„Kafka Topicå’ŒPartitionæŒ‡å—
- ğŸ—ï¸ **æœ¬æ–‡æ¡£**: åŒ…å«å®Œæ•´çš„é‡æ„å†ç¨‹ã€æœåŠ¡å±‚æ¶æ„ã€é›†æˆç¤ºä¾‹å’ŒéªŒè¯æŠ¥å‘Š

## ğŸ“ˆ ä¸‹ä¸€æ­¥ä¼˜åŒ–å»ºè®®

### **Phase 3: è¿›é˜¶åŠŸèƒ½æ‰©å±•**

1. **æ¥å£å±‚å®šä¹‰**: ä¸ºæ‰€æœ‰æœåŠ¡æ·»åŠ æ¥å£å®šä¹‰ï¼Œè¿›ä¸€æ­¥æé«˜å¯æµ‹è¯•æ€§
2. **è®¤è¯ä¸­é—´ä»¶**: åŸºäºç°æœ‰ServiceManageræ·»åŠ JWTè®¤è¯ä¸­é—´ä»¶
3. **é™æµä¸­é—´ä»¶**: åˆ©ç”¨CacheServiceå®ç°æ™ºèƒ½APIé™æµä¿æŠ¤
4. **ç›‘æ§å‘Šè­¦**: åŸºäºTimeServiceæ„å»ºæŒ‡æ ‡æ”¶é›†å’Œå‘Šè­¦ç³»ç»Ÿ
5. **A/Bæµ‹è¯•**: åŸºäºUserServiceå®ç°ç”¨æˆ·å®éªŒåˆ†ç»„åŠŸèƒ½
6. **å®æ—¶æ¨è**: åŸºäºStatsServiceæ„å»ºæ™ºèƒ½æ¨èå¼•æ“
7. **è‡ªåŠ¨åŒ–è¿ç»´**: åŸºäºå¥åº·æ£€æŸ¥å®ç°è‡ªåŠ¨æ‰©ç¼©å®¹

### **æµ‹è¯•å’Œè´¨é‡**

8. **å•å…ƒæµ‹è¯•**: ä¸ºæ‰€æœ‰æœåŠ¡å’Œä¸­é—´ä»¶æ·»åŠ å®Œæ•´æµ‹è¯•å¥—ä»¶
9. **é›†æˆæµ‹è¯•**: ç«¯åˆ°ç«¯çš„APIæµ‹è¯•è¦†ç›–
10. **æ€§èƒ½æµ‹è¯•**: ç¼“å­˜å‘½ä¸­ç‡å’Œå“åº”æ—¶é—´åŸºå‡†æµ‹è¯•
11. **å‹åŠ›æµ‹è¯•**: é«˜å¹¶å‘åœºæ™¯ä¸‹çš„ç¨³å®šæ€§éªŒè¯

### **è¿ç»´å’Œç›‘æ§**

12. **Kafkaç›‘æ§**: æ·»åŠ è¯¦ç»†çš„Kafkaæ€§èƒ½æŒ‡æ ‡ç›‘æ§
13. **æœåŠ¡ç›‘æ§**: ServiceManagerå„æœåŠ¡çš„æ€§èƒ½æŒ‡æ ‡
14. **ç¼“å­˜ç›‘æ§**: Redisç¼“å­˜å‘½ä¸­ç‡å’Œæ€§èƒ½åˆ†æ
15. **æ—¥å¿—èšåˆ**: åŸºäºæ ‡å‡†åŒ–æ—¥å¿—çš„åˆ†æç³»ç»Ÿ

### **æ¶æ„è¿›åŒ–**

16. **å¾®æœåŠ¡æ‹†åˆ†**: åŸºäºå½“å‰æœåŠ¡å±‚è¿›è¡Œå¾®æœåŠ¡æ¶æ„æ¼”è¿›
17. **åˆ†å¸ƒå¼ç¼“å­˜**: æ‰©å±•CacheServiceæ”¯æŒåˆ†å¸ƒå¼ç¼“å­˜
18. **äº‹ä»¶é©±åŠ¨**: åŸºäºKafkaæ„å»ºå®Œæ•´çš„äº‹ä»¶é©±åŠ¨æ¶æ„
19. **å¤šæ•°æ®æº**: æ‰©å±•æ•°æ®è®¿é—®å±‚æ”¯æŒå¤šç§æ•°æ®æº

## âœ… é‡æ„å®ŒæˆçŠ¶æ€ (å®Œå…¨æˆåŠŸ)

### **Phase 1: åˆ†å±‚æ¶æ„** âœ…

- âœ… ä»£ç ç¼–è¯‘é€šè¿‡
- âœ… ä¿æŒåŸæœ‰åŠŸèƒ½ä¸å˜
- âœ… æ¨¡å—åŒ–æ¶æ„å®Œæˆ
- âœ… ä¾èµ–å…³ç³»æ¸…æ™°
- âœ… é…ç½®ç®¡ç†ç‹¬ç«‹
- âœ… åŸºç¡€è®¾æ–½å±‚åˆ†ç¦»
- âœ… ä¸­é—´ä»¶æ¶æ„å®Œæˆ
- âœ… æ— é‡å¤ä»£ç 
- âœ… Kafkaæ¶æ„ä¼˜åŒ–
- âœ… å‘åå…¼å®¹è®¾è®¡

### **Phase 2: ServiceManageræ·±åº¦é›†æˆ** âœ…

- âœ… **æ¶æ„å®Œæ•´æ€§**: æ‰€æœ‰å±‚çº§éƒ½å·²é›†æˆæœåŠ¡
- âœ… **åŠŸèƒ½å®Œæ•´æ€§**: æ‰€æœ‰ä¸šåŠ¡é€»è¾‘éƒ½å·²æœåŠ¡åŒ–
- âœ… **æ€§èƒ½ä¼˜åŒ–**: æ™ºèƒ½ç¼“å­˜å’Œæ—¶é—´çª—å£ä¼˜åŒ–
- âœ… **ä»£ç è´¨é‡**: ç»Ÿä¸€æ ‡å‡†å’Œé”™è¯¯å¤„ç†
- âœ… **å¯ç»´æŠ¤æ€§**: æ¸…æ™°çš„åˆ†å±‚å’ŒèŒè´£åˆ†ç¦»
- âœ… **å¯æ‰©å±•æ€§**: ä¸ºæœªæ¥åŠŸèƒ½é¢„ç•™è‰¯å¥½æ¥å£
- âœ… **ç¼–è¯‘éªŒè¯**: 100%æ— é”™è¯¯ç¼–è¯‘é€šè¿‡
- âœ… **åŠŸèƒ½éªŒè¯**: 100%APIç«¯ç‚¹æœåŠ¡åŒ–
- âœ… **ä¸€è‡´æ€§éªŒè¯**: 100%ä¸šåŠ¡é€»è¾‘æ ‡å‡†åŒ–

## ğŸŠ é‡æ„å†ç¨‹æ€»ç»“

### **æ€»ä½“æˆå°±**

ä»**532è¡Œå†—æ‚çš„main.go**åˆ°**ä¼ä¸šçº§åˆ†å±‚æœåŠ¡æ¶æ„**çš„å®Œæ•´è½¬å˜ï¼š

1. **ä»£ç è¡Œæ•°ä¼˜åŒ–**: ä¸»æ–‡ä»¶ä»532è¡Œå‡å°‘åˆ°66è¡Œ (-88%)
2. **æ¶æ„æˆç†Ÿåº¦**: ä»â­â­æå‡åˆ°â­â­â­â­â­ (+150%)
3. **æ€§èƒ½æå‡**: ç»Ÿè®¡æŸ¥è¯¢å“åº”æ—¶é—´å‡å°‘50-80%
4. **ç¼“å­˜æ•ˆç‡**: é¢„æœŸç¼“å­˜å‘½ä¸­ç‡85-95%
5. **ä»£ç è´¨é‡**: ä¸šåŠ¡é€»è¾‘100%æœåŠ¡åŒ–ç®¡ç†

### **æŠ€æœ¯æ ˆå‡çº§**

- âœ… **ä»å•æ–‡ä»¶åˆ°åˆ†å±‚**: æ¸…æ™°çš„æ¨¡å—åŒ–æ¶æ„
- âœ… **ä»åˆ†æ•£åˆ°é›†ä¸­**: ServiceManagerç»Ÿä¸€ç®¡ç†
- âœ… **ä»ç¡¬ç¼–ç åˆ°æœåŠ¡**: æ‰€æœ‰ä¸šåŠ¡é€»è¾‘æœåŠ¡åŒ–
- âœ… **ä»æ— ç¼“å­˜åˆ°æ™ºèƒ½ç¼“å­˜**: å¤šå±‚çº§ç¼“å­˜ç­–ç•¥
- âœ… **ä»åŸºç¡€ä¸­é—´ä»¶åˆ°æœåŠ¡å¢å¼º**: ä¸­é—´ä»¶ä¸æœåŠ¡æ·±åº¦é›†æˆ

**ğŸ‰ é‡æ„å®Œå…¨æˆåŠŸï¼** æ‚¨çš„ç”¨æˆ·è¡Œä¸ºåˆ†æç³»ç»Ÿç°åœ¨å…·å¤‡äº†**ä¼ä¸šçº§æ¶æ„æ ‡å‡†**å’Œ**å·¥ä¸šçº§æ€§èƒ½è¡¨ç°**ï¼

## ğŸ”® æœªæ¥æ‰©å±•èƒ½åŠ›å±•ç¤º

åŸºäºå½“å‰çš„ServiceManageræ¶æ„ï¼Œç³»ç»Ÿä¸ºä»¥ä¸‹åŠŸèƒ½æ‰©å±•æä¾›äº†å®Œå–„çš„åŸºç¡€ï¼š

### **ç›‘æ§å‘Šè­¦ç³»ç»Ÿ** ğŸ“Š

```go
// åŸºäºTimeServiceçš„æŒ‡æ ‡æ”¶é›†
metricsService := services.NewMetricsService(serviceManager)
metricsService.CollectAPIMetrics()        // APIæ€§èƒ½æŒ‡æ ‡
metricsService.CollectCacheMetrics()      // ç¼“å­˜å‘½ä¸­ç‡
metricsService.CollectEventMetrics()      // äº‹ä»¶å¤„ç†æŒ‡æ ‡
```

### **æ™ºèƒ½é™æµç³»ç»Ÿ** ğŸš¦

```go
// åŸºäºCacheServiceçš„é™æµç­–ç•¥
rateLimiter := middleware.NewRateLimiter(serviceManager)
rateLimiter.SetUserLimit("user123", 1000)    // ç”¨æˆ·çº§é™æµ
rateLimiter.SetAPILimit("/api/events", 5000) // APIçº§é™æµ
rateLimiter.SetGlobalLimit(10000)            // å…¨å±€é™æµ
```

### **A/Bæµ‹è¯•å¹³å°** ğŸ§ª

```go
// åŸºäºUserServiceçš„å®éªŒåˆ†ç»„
experimentService := services.NewExperimentService(serviceManager)
userGroup := experimentService.GetUserGroup("user123", "homepage_v2")
if userGroup == "treatment" {
    // å±•ç¤ºæ–°ç‰ˆæœ¬
} else {
    // å±•ç¤ºå¯¹ç…§ç‰ˆæœ¬
}
```

### **å®æ—¶æ¨èå¼•æ“** ğŸ¯

```go
// åŸºäºStatsServiceçš„æ™ºèƒ½æ¨è
recommendService := services.NewRecommendService(serviceManager)
hotPages := recommendService.GetTrendingPages(userID)
personalRecs := recommendService.GetPersonalizedContent(userID)
```

### **è‡ªåŠ¨åŒ–è¿ç»´** ğŸ¤–

```go
// åŸºäºå¥åº·æ£€æŸ¥çš„è‡ªåŠ¨æ‰©ç¼©å®¹
opsService := services.NewOpsService(serviceManager)
if opsService.GetSystemLoad() > 0.8 {
    opsService.TriggerScaleUp()    // è§¦å‘æ‰©å®¹
}
if opsService.GetErrorRate() > 0.05 {
    opsService.TriggerAlert()      // è§¦å‘å‘Šè­¦
}
```

### **æ•°æ®è´¨é‡ç›‘æ§** ğŸ”

```go
// åŸºäºEventValidatorçš„æ•°æ®è´¨é‡åˆ†æ
qualityService := services.NewDataQualityService(serviceManager)
qualityMetrics := qualityService.AnalyzeDataQuality(timeRange)
// è‡ªåŠ¨è¯†åˆ«å¼‚å¸¸æ•°æ®æ¨¡å¼ï¼Œæä¾›æ•°æ®è´¨é‡æŠ¥å‘Š
```

## ğŸ” Kafka Topic vs Partition æ·±åº¦è§£æ

### æ ¸å¿ƒæ¦‚å¿µåŒºåˆ«

#### Topicï¼ˆä¸»é¢˜ï¼‰- é€»è¾‘æ¦‚å¿µ

```
Topic = æ¶ˆæ¯åˆ†ç±»å®¹å™¨ = æ•°æ®åº“ä¸­çš„"è¡¨"
```

- ğŸ“‚ **ä½œç”¨**: æ¶ˆæ¯çš„é€»è¾‘åˆ†ç±»
- ğŸ·ï¸ **ä¾‹å­**: `user_events`, `order_events`, `payment_events`
- ğŸ‘€ **ç”¨æˆ·è§†è§’**: Producerå‘é€åˆ°topicï¼ŒConsumerä»topicè¯»å–

#### Partitionï¼ˆåˆ†åŒºï¼‰- ç‰©ç†æ¦‚å¿µ

```
Partition = æ¶ˆæ¯å­˜å‚¨å•å…ƒ = æ•°æ®åº“è¡¨çš„"åˆ†ç‰‡"
```

- ğŸ“ **ä½œç”¨**: Topicçš„å®é™…å­˜å‚¨å’Œå¤„ç†å•ä½
- ğŸ’¾ **ä¾‹å­**: `user_events-0`, `user_events-1`, `user_events-2`
- âš™ï¸ **ç³»ç»Ÿè§†è§’**: çœŸæ­£å­˜å‚¨æ•°æ®å’Œå¹¶è¡Œå¤„ç†çš„åœ°æ–¹

### å±‚çº§å…³ç³»

```
Topic (é€»è¾‘å±‚)
â”œâ”€â”€ Partition-0 (ç‰©ç†å±‚)
â”œâ”€â”€ Partition-1 (ç‰©ç†å±‚)
â”œâ”€â”€ Partition-2 (ç‰©ç†å±‚)
â””â”€â”€ Partition-3 (ç‰©ç†å±‚)
```

### åœ¨æˆ‘ä»¬é¡¹ç›®ä¸­çš„åº”ç”¨

#### å½“å‰æ¶æ„ï¼ˆå•åˆ†åŒºï¼‰

```go
// å½“å‰çŠ¶æ€
Topic: "user_events"
Partitions: 1 (é»˜è®¤)

// æ•°æ®æµ
å‰ç«¯äº‹ä»¶ â†’ Producer â†’ user_events-0 â†’ Consumer â†’ æ•°æ®åº“
```

**ä¼˜åŠ¿**:

- âœ… é…ç½®ç®€å•
- âœ… å…¨å±€æ¶ˆæ¯é¡ºåº
- âœ… é€‚åˆä¸­å°å‹é¡¹ç›®
- âœ… å®¹æ˜“è°ƒè¯•å’Œç›‘æ§

**é™åˆ¶**:

- âŒ æ— æ³•å¹¶è¡Œå¤„ç†
- âŒ å•ç‚¹ç“¶é¢ˆ
- âŒ æ‰©å±•æ€§æœ‰é™

#### å‡çº§æ–¹æ¡ˆï¼ˆå¤šåˆ†åŒºï¼‰

```go
// ä¼˜åŒ–åçŠ¶æ€
Topic: "user_events"
Partitions: 3-5 (å»ºè®®)

// æ•°æ®æµ (å¹¶è¡Œ)
å‰ç«¯äº‹ä»¶ â†’ Producer â†’ user_events-0 â†’ Consumer-A
           â†˜     â†’ user_events-1 â†’ Consumer-B
           â†˜     â†’ user_events-2 â†’ Consumer-C
```

**ä¼˜åŠ¿**:

- âœ… å¹¶è¡Œå¤„ç†
- âœ… æ›´é«˜ååé‡  
- âœ… æ›´å¥½æ‰©å±•æ€§
- âœ… è´Ÿè½½åˆ†å¸ƒ

**æ³¨æ„äº‹é¡¹**:

- âš ï¸ æ— æ³•ä¿è¯å…¨å±€é¡ºåº
- âš ï¸ é…ç½®å¤æ‚åº¦å¢åŠ 
- âš ï¸ éœ€è¦åˆç†åˆ†åŒºç­–ç•¥

### åˆ†åŒºç­–ç•¥è¯¦è§£

#### 1. Hashåˆ†åŒºï¼ˆå½“å‰ä½¿ç”¨ï¼‰

```go
// åŸºäºUserIDåˆ†åŒº
config.Producer.Partitioner = sarama.NewHashPartitioner

message := &sarama.ProducerMessage{
    Topic: "user_events",
    Key:   sarama.StringEncoder(event.UserID), // åˆ†åŒºkey
    Value: sarama.ByteEncoder(eventJSON),
}

// ç»“æœï¼šç›¸åŒUserIDçš„äº‹ä»¶æ€»æ˜¯å‘åˆ°åŒä¸€åˆ†åŒº
user_123 â†’ Partition-0 (å§‹ç»ˆ)
user_456 â†’ Partition-1 (å§‹ç»ˆ)
user_789 â†’ Partition-2 (å§‹ç»ˆ)
```

**é€‚ç”¨åœºæ™¯**:

- âœ… éœ€è¦ä¿è¯åŒä¸€ç”¨æˆ·äº‹ä»¶é¡ºåº
- âœ… ç”¨æˆ·è¡Œä¸ºåˆ†æ
- âœ… ä¼šè¯è·Ÿè¸ª

#### 2. è½®è¯¢åˆ†åŒº

```go
// å¹³å‡åˆ†å¸ƒ
config.Producer.Partitioner = sarama.NewRoundRobinPartitioner

// ç»“æœï¼šæ¶ˆæ¯ä¾æ¬¡å‘é€åˆ°ä¸åŒåˆ†åŒº
Message-1 â†’ Partition-0
Message-2 â†’ Partition-1
Message-3 â†’ Partition-2
Message-4 â†’ Partition-0 (å¾ªç¯)
```

**é€‚ç”¨åœºæ™¯**:

- âœ… éœ€è¦è´Ÿè½½å‡è¡¡
- âœ… ä¸éœ€è¦ä¸¥æ ¼é¡ºåº
- âœ… é«˜ååé‡åœºæ™¯

### åˆ†åŒºæ•°é‡é€‰æ‹©æŒ‡å—

#### å°å‹é¡¹ç›®ï¼ˆå½“å‰é€‚ç”¨ï¼‰

```bash
æ—¥æ´»ç”¨æˆ·: < 10ä¸‡
äº‹ä»¶é‡: < 100ä¸‡/å¤©
åˆ†åŒºæ•°: 1-2ä¸ª
ä¼˜ç‚¹: ç®€å•å¯é ï¼Œå…¨å±€æœ‰åº
```

#### ä¸­å‹é¡¹ç›®

```bash
æ—¥æ´»ç”¨æˆ·: 10ä¸‡-100ä¸‡
äº‹ä»¶é‡: 100ä¸‡-1000ä¸‡/å¤©
åˆ†åŒºæ•°: 3-6ä¸ª
ä¼˜ç‚¹: æ€§èƒ½æå‡ï¼Œå¤æ‚åº¦å¯æ§
```

#### å¤§å‹é¡¹ç›®

```bash
æ—¥æ´»ç”¨æˆ·: > 100ä¸‡
äº‹ä»¶é‡: > 1000ä¸‡/å¤©
åˆ†åŒºæ•°: 6-12ä¸ª
ä¼˜ç‚¹: é«˜æ€§èƒ½ï¼Œé«˜å¯ç”¨
```

### å®é™…é…ç½®ç¤ºä¾‹

#### æŸ¥çœ‹å½“å‰åˆ†åŒºä¿¡æ¯

```bash
# æ£€æŸ¥topicåˆ†åŒºæ•°
kafka-topics.sh --bootstrap-server localhost:9092 \
  --describe --topic user_events

# è¾“å‡ºç¤ºä¾‹
Topic: user_events  PartitionCount: 1  ReplicationFactor: 1
    Partition: 0    Leader: 0    Replicas: 0    Isr: 0
```

#### å¢åŠ åˆ†åŒºæ•°é‡

```bash
# å°†topicæ‰©å±•åˆ°3ä¸ªåˆ†åŒº
kafka-topics.sh --bootstrap-server localhost:9092 \
  --alter --topic user_events \
  --partitions 3

# âš ï¸ æ³¨æ„ï¼šåªèƒ½å¢åŠ åˆ†åŒºï¼Œä¸èƒ½å‡å°‘ï¼
```

#### Consumerå¹¶è¡Œæ¶ˆè´¹

```go
// æˆ‘ä»¬çš„Consumerå·²ç»æ”¯æŒå¤šåˆ†åŒºå¹¶è¡Œæ¶ˆè´¹
func (kc *KafkaConsumer) Start(eventHandler func(models.UserEvent)) error {
    partitions, err := kc.consumer.Partitions(kc.topic)
    log.Printf("åˆ†åŒºæ•°é‡: %d", len(partitions))
    
    // ä¸ºæ¯ä¸ªåˆ†åŒºå¯åŠ¨goroutine
    for _, partition := range partitions {
        go func(partitionID int32) {
            // å¹¶è¡Œæ¶ˆè´¹åˆ†åŒºæ•°æ®
        }(partition)
    }
}
```

### æœ€ä½³å®è·µå»ºè®®

#### 1. æ¸è¿›å¼æ‰©å±•

```bash
é˜¶æ®µ1: å•åˆ†åŒºï¼ˆå½“å‰ï¼‰ â†’ ä¸“æ³¨ä¸šåŠ¡é€»è¾‘
é˜¶æ®µ2: 3-5åˆ†åŒº â†’ æ€§èƒ½ä¼˜åŒ–
é˜¶æ®µ3: 6+åˆ†åŒº â†’ é«˜å¹¶å‘åœºæ™¯
```

#### 2. ç›‘æ§å…³é”®æŒ‡æ ‡

```bash
- Consumer Lagï¼ˆæ¶ˆè´¹å»¶è¿Ÿï¼‰
- Partitionåˆ†å¸ƒæ˜¯å¦å‡åŒ€
- æ¶ˆæ¯å¤„ç†é€Ÿåº¦
- é”™è¯¯ç‡ç»Ÿè®¡
```

#### 3. åˆ†åŒºkeyé€‰æ‹©

```bash
âœ… å¥½çš„åˆ†åŒºkey:
- UserIDï¼ˆä¿è¯ç”¨æˆ·äº‹ä»¶é¡ºåºï¼‰
- DeviceIDï¼ˆè®¾å¤‡ç»´åº¦åˆ†æï¼‰
- SessionIDï¼ˆä¼šè¯ç»´åº¦è¿½è¸ªï¼‰

âŒ é¿å…çš„åˆ†åŒºkey:
- æ—¶é—´æˆ³ï¼ˆçƒ­ç‚¹åˆ†åŒºï¼‰
- éšæœºå­—ç¬¦ä¸²ï¼ˆæ— ä¸šåŠ¡æ„ä¹‰ï¼‰
- ç©ºå€¼ï¼ˆå¤±å»åˆ†åŒºä¼˜åŠ¿ï¼‰
```

### æ€»ç»“

**å½“å‰è®¾è®¡è¯„ä»·**: âœ… **å®Œå…¨æ­£ç¡®ï¼**

ä½ çš„é¡¹ç›®ä½¿ç”¨å•ä¸ªTopicå’ŒProducer/Consumerä½¿ç”¨åŒä¸€Topicçš„è®¾è®¡æ˜¯**æ ‡å‡†ä¸”æ­£ç¡®**çš„Kafkaä½¿ç”¨æ–¹å¼ã€‚

**å…³é”®ç†è§£**:

- **Topic** = é€»è¾‘åˆ†ç±»ï¼Œä¸šåŠ¡æ¦‚å¿µ
- **Partition** = ç‰©ç†å­˜å‚¨ï¼Œæ€§èƒ½æ¦‚å¿µ
- **å•åˆ†åŒº** = ç®€å•å¯é ï¼Œé€‚åˆå½“å‰é˜¶æ®µ
- **å¤šåˆ†åŒº** = æ€§èƒ½æ‰©å±•ï¼Œé€‚åˆæœªæ¥ä¼˜åŒ–

ä½ çš„æ¶æ„ä¸ºæœªæ¥æ‰©å±•é¢„ç•™äº†å……åˆ†çš„ç©ºé—´ï¼Œå½“å‰é˜¶æ®µä¸“æ³¨ä¸šåŠ¡é€»è¾‘å¼€å‘æ˜¯æ˜æ™ºçš„é€‰æ‹©ï¼ğŸ‰
